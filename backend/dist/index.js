var re=Object.create;var F=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var ie=Object.getPrototypeOf,ue=Object.prototype.hasOwnProperty;var ce=(s,e,r)=>e in s?F(s,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[e]=r;var me=(s,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of ne(e))!ue.call(s,a)&&a!==r&&F(s,a,{get:()=>e[a],enumerable:!(t=oe(e,a))||t.enumerable});return s};var g=(s,e,r)=>(r=s!=null?re(ie(s)):{},me(e||!s||!s.__esModule?F(r,"default",{value:s,enumerable:!0}):r,s));var f=(s,e,r)=>ce(s,typeof e!="symbol"?e+"":e,r);var pe=require("dotenv/config");var E=class{constructor(){f(this,"PORT");f(this,"DATABASE_URL");f(this,"JWT_SECRET");f(this,"email_sender");f(this,"email_sender_pass");f(this,"Front_url");f(this,"ENVIRONMENT");this.PORT=Number(process.env.PORT)||3500,this.DATABASE_URL=process.env.DATABASE_URL||"",this.JWT_SECRET=process.env.JWT_SECRET||"udduLovesToGetDominated",this.ENVIRONMENT=process.env.ENVIRONMENT||"development"}verifyConfig(){let e=[];if(["DATABASE_URL"].forEach(t=>{process.env[t]||e.push(`Missing ${t} in environment variables`)}),e.length>0)throw new Error(e.join(`
`))}},y=new E;var D=g(require("express")),ae=g(require("cors"));var L=(s,e,r,t)=>{let a=s.status||500;switch(a){case 400:return r.status(a).json({message:"Bad Request"});case 401:return r.status(a).json({message:"Unauthorized"});case 403:return r.status(a).json({message:"Forbidden"});case 404:return r.status(a).json({message:"Not Found"})}return console.error(s),r.status(a).json({message:"Something went wrong. Please try again later."})};var B=g(require("jsonwebtoken"));var j=class{constructor(){f(this,"create_token",async(e,r,t="")=>B.default.sign({email:e,owner:r,business:t},y.JWT_SECRET,{expiresIn:"48h"}))}},N=new j;var P=g(require("bcryptjs"));var v=class{constructor(){f(this,"password_crypt",async e=>{let r=await P.default.genSalt(10);return P.default.hash(e,r)});f(this,"password_compare",async(e,r)=>await P.default.compare(e,r))}},_=new v;var M=require("@prisma/client");var i;y.ENVIRONMENT==="production"?i=new M.PrismaClient:(globalThis.prisma||(globalThis.prisma=new M.PrismaClient),i=globalThis.prisma);var k=(s,e)=>{let r=new Date,t=s.registeredAt,a=(r.getTime()-t.getTime())/(1e3*60*60*24*365),o=e.reduce((x,h)=>x+h.income,0);a<.3?o*=.8:a<1.5?o*=.9:a>2&&(o*=1.1);let u=3,l=e.reduce((x,h)=>x+h.income,0),m=e.reduce((x,h)=>x+h.loss,0),p=l/(m||1);p>2&&u++,p>4&&u++,p<1&&u--,p<.5&&u--;let n=e.reduce((x,h)=>x+h.taxPaid,0),c=e.reduce((x,h)=>x+h.taxPayable,0),b=n/(c||1);b>.9&&u++,b<.7&&u--;let d=Math.max(1,Math.min(5,u));return{sumAssured:o,safetyRating:d}};var X=g(require("express"));var w=g(require("zod")),C=w.default.object({promoter_name:w.default.string(),business_name:w.default.string(),email:w.default.string().email(),password:w.default.string()}),O=w.default.object({email:w.default.string().email(),password:w.default.string()});var I=g(require("zod")),U=I.default.object({date:I.default.string(),id:I.default.string(),amount:I.default.number(),invoice:I.default.string()});var W=async(s,e,r)=>{try{let t=s.body,a=C.safeParse(t);if(!a.success)return e.status(403).json({message:"enter required fields"});if(await i.user.findFirst({where:{email:a.data.email}}))return e.status(400).json({message:"email already exists"});if(await i.user.findFirst({where:{AND:[{business_name:a.data.business_name.toLowerCase()},{promoter_name:a.data.promoter_name.toLowerCase()}]}}))return e.status(400).json({message:"business already added"});let l=await _.password_crypt(a.data.password);await i.user.create({data:{email:a.data.email,password:l,business_name:a.data.business_name.toLowerCase(),promoter_name:a.data.promoter_name.toLowerCase()}});let m=await N.create_token(a.data.email,a.data.promoter_name,a.data.business_name);e.status(201).json({message:"business registered successfully",token:m})}catch(t){r(t)}};var J=async(s,e,r)=>{try{let t=s.body,a=O.safeParse(t);if(!a.success)return e.status(403).json({message:"enter required fields"});let o=await i.user.findFirst({where:{email:a.data.email}});if(!o)return e.status(400).json({message:"email is incorrect"});if(!await _.password_compare(a.data.password,o.password))return e.status(400).json({message:"password is incorrect"});let l=await N.create_token(a.data.email,o.promoter_name,o.business_name);e.status(201).json({message:"business Login successfully",token:l})}catch(t){r(t)}};var V=async(s,e,r)=>{try{let t=s.user.email,a=s.body;console.log(a);let o=U.safeParse(a);if(!o.success)return e.status(403).json({message:"enter required fields"});let u=await i.user.findFirst({where:{email:t},select:{id:!0,sumAssured:!0}}),l=await i.user.findFirst({where:{id:o.data.id},select:{id:!0,sumAssured:!0}});return!u||!l?e.status(200).json({message:"seller or buyer not found"}):o.data.amount>l?.sumAssured||o.data.amount>u?.sumAssured?e.status(200).json({message:"Insufficient Sum assured"}):(await i.transaction.create({data:{buyerId:u.id,sellerId:l.id,amount:o.data.amount,date:o.data.date,invoice:a.invoice,status:"PENDING"}}),e.status(200).json({message:"transaction initiated"}))}catch(t){r(t)}},z=async(s,e,r)=>{try{let t=s.user.email,a=await i.user.findFirst({where:{email:t},select:{id:!0}}),o=await i.transaction.findMany({where:{buyerId:a?.id},orderBy:{date:"desc"},take:10});if(!o||o.length===0)return e.status(200).json([]);let u=[...new Set(o.map(n=>n.sellerId))],m=(await i.user.findMany({where:{id:{in:u}},select:{id:!0,business_name:!0}})).reduce((n,c)=>(n[c.id]=c.business_name,n),{}),p=o.map(n=>{let c=m[n.sellerId],d=new Date(n.date).toLocaleString("default",{day:"2-digit",month:"long"});return{id:n.id,date:d,amount:n.amount,status:n.status,sellerName:c}});e.send(p)}catch(t){r(t)}},$=async(s,e,r)=>{try{let t=s.user.email,a=await i.user.findFirst({where:{email:t},select:{id:!0}}),o=await i.transaction.findMany({where:{sellerId:a?.id},take:10,orderBy:{date:"desc"}});if(!o||o.length===0)return e.status(200).json([]);let u=[...new Set(o.map(n=>n.buyerId))],m=(await i.user.findMany({where:{id:{in:u}},select:{id:!0,business_name:!0}})).reduce((n,c)=>(n[c.id]=c.business_name,n),{}),p=o.map(n=>{let c=m[n.buyerId],d=new Date(n.date).toLocaleString("default",{month:"long",day:"2-digit"});return{id:n.id,date:d,amount:n.amount,status:n.status,buyerName:c}});e.send(p)}catch(t){r(t)}},G=async(s,e,r)=>{try{let t=s.user.email,a=await i.user.findFirst({where:{email:t},select:{id:!0}}),o=await i.transaction.findMany({where:{sellerId:a?.id,status:"PENDING"},take:10,orderBy:{date:"desc"}});if(!o||o.length===0)return e.status(200).json([]);let u=[...new Set(o.map(n=>n.buyerId))],m=(await i.user.findMany({where:{id:{in:u}},select:{id:!0,business_name:!0}})).reduce((n,c)=>(n[c.id]=c.business_name,n),{}),p=o.map(n=>{let c=new Date(n.date),b=`${c.getDate().toString().padStart(2,"0")}-${(c.getMonth()+1).toString().padStart(2,"0")}`;return{id:n.id,amount:n.amount,business_name:m[n.buyerId],date:b}});e.status(200).json(p)}catch(t){r(t)}},H=async(s,e,r)=>{try{let{id:t,type:a}=s.body;console.log(t);let o=await i.transaction.update({where:{id:t},data:{status:a}});e.send({message:"Approved"})}catch(t){r(t)}};var Y=g(require("axios")),Z=g(require("pdf-parse"));var K=async(s,e,r)=>{try{let t=s.user.email,a=s.body.url,o=await Y.default.get(a,{responseType:"arraybuffer"}),l=(await(0,Z.default)(o.data)).text,m=de(l);if("message"in m)return e.json(m);let p=await i.user.findFirst({where:{email:t}});if(!p)return e.status(400).json({message:"user not found"});let n=await i.funds.create({data:{name:m.name,formNumber:m.formNumber,loss:m.loss,income:m.income,taxPayable:m.taxPayable,taxPaid:m.taxPaid,userId:p.id}}),c=await i.funds.findMany({where:{userId:p.id}}),b=k(p,c);await i.user.update({where:{id:p.id},data:{sumAssured:b.sumAssured,safetyRating:b.safetyRating}}),e.json(n)}catch(t){r(t)}};function de(s){let e={name:"",formNumber:"",businessLoss:0,totalIncome:0,totalTaxInterestFeePayable:0,taxesPaid:0,accretedIncome:0,additionalTaxInterestPayable:0,taxInterestPaid:0},r={name:"",formNumber:"",loss:NaN,income:NaN,taxPaid:NaN,taxPayable:NaN},t=s.match(/Name([A-Z\s]+)/);t&&(e.name=t[1].trim().substring(0,t[1].trim().length-2));let a=s.match(/Form Number([A-Z0-9-]+)/);a&&(e.formNumber=a[1].trim());let o=s.match(/Total Income\s*([\d,]+)/);if(o){let d=o[1].trim().replace(/,/g,"");e.formNumber==="ITR-4"?e.totalIncome=parseFloat(d)||0:e.totalIncome=parseFloat(d.substring(1))||0}let u=s.match(/Current Year business loss, if any\s*([\d,]+)/);if(u){let d=u[1].trim().replace(/,/g,"");e.businessLoss=parseFloat(d.substring(1))||0}let l=s.match(/Total tax, interest and Fee payable\s*([\d,]+)/);if(l){let d=l[1].trim().replace(/,/g,"");e.totalTaxInterestFeePayable=parseFloat(d.substring(1))||0}let m=s.match(/Taxes Paid\s*([\d,]+)/);if(m){let d=m[1].trim().replace(/,/g,"");e.taxesPaid=parseFloat(d.substring(1))||0}let p=s.match(/Accreted Income as per section 115TD\s*([\d,]+)/);if(p){let d=p[1].trim().replace(/,/g,"");e.accretedIncome=parseFloat(d.substring(2))||0}let n=s.match(/Additional Tax and interest payable\s*([\d,]+)/);if(n){let d=n[1].trim().replace(/,/g,"");e.additionalTaxInterestPayable=parseFloat(d.substring(2))||0}let c=s.match(/Tax and interest paid\s*([\d,]+)/);if(c){let d=c[1].trim().replace(/,/g,"");e.taxInterestPaid=parseFloat(d.substring(2))||0}return r.name=e.name,r.formNumber=e.formNumber,r.loss=e.businessLoss,r.income=e.totalIncome+e.accretedIncome,r.taxPaid=e.taxesPaid+e.taxInterestPaid,r.taxPayable=e.totalTaxInterestFeePayable+e.additionalTaxInterestPayable,["ITR-3","ITR-4","ITR-5","ITR-7"].includes(r.formNumber)?r:{message:"document is not valid"}}var Q=async(s,e,r)=>{try{let{query:t}=s.query;if(typeof t!="string")return e.status(400).json({error:"Invalid search query"});let a=await i.user.findMany({where:{OR:[{business_name:{contains:t,mode:"insensitive"}},{promoter_name:{contains:t,mode:"insensitive"}}]},select:{id:!0,business_name:!0,promoter_name:!0,sumAssured:!0,safetyRating:!0},take:10});e.status(200).json(a)}catch{e.status(500).json({error:"Error searching users"})}};var A=X.default.Router();A.post("/register",W).post("/login",J);var se=g(require("express"));var os=require("dotenv/config"),ee=g(require("jsonwebtoken"));async function T(s,e,r){let t=s.headers.authorization;if(!t)return e.status(403).json({success:!1,data:"Not Authorised"});try{let o=t.split(" ")[1],l=ee.default.verify(o,y.JWT_SECRET);s.user=l}catch(a){return a instanceof Error?e.status(400).json({success:!1,data:a.message}):e.status(400).json({success:!1,data:"Something went wrong"})}r()}var S=se.default.Router();S.post("/new",T,V).get("/buyer",T,z).get("/seller",T,$).post("/search",Q).get("/pending",T,G).post("/approve",H);var te=g(require("express"));var q=te.default.Router();q.post("/add",T,K);var R=(0,D.default)();R.use((0,ae.default)());R.use(D.default.json());R.get("/",(s,e)=>{e.json({message:"Welcome to the TrustTrade"})});R.use("/auth",A);R.use("/transact",S);R.use("/funds",q);R.use(L);y.verifyConfig();R.listen(y.PORT,()=>{console.log(`Server running on port ${y.PORT}`)});
//# sourceMappingURL=index.js.map
