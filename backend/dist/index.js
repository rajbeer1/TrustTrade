var ie=Object.create;var P=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var me=Object.getPrototypeOf,de=Object.prototype.hasOwnProperty;var le=(a,e,r)=>e in a?P(a,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[e]=r;var pe=(a,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ce(e))!de.call(a,s)&&s!==r&&P(a,s,{get:()=>e[s],enumerable:!(t=ue(e,s))||t.enumerable});return a};var g=(a,e,r)=>(r=a!=null?ie(me(a)):{},pe(e||!a||!a.__esModule?P(r,"default",{value:a,enumerable:!0}):r,a));var f=(a,e,r)=>le(a,typeof e!="symbol"?e+"":e,r);var be=require("dotenv/config");var j=class{constructor(){f(this,"PORT");f(this,"DATABASE_URL");f(this,"JWT_SECRET");f(this,"email_sender");f(this,"email_sender_pass");f(this,"Front_url");f(this,"ENVIRONMENT");this.PORT=Number(process.env.PORT)||3500,this.DATABASE_URL=process.env.DATABASE_URL||"",this.JWT_SECRET=process.env.JWT_SECRET||"udduLovesToGetDominated",this.ENVIRONMENT=process.env.ENVIRONMENT||"development"}verifyConfig(){let e=[];if(["DATABASE_URL"].forEach(t=>{process.env[t]||e.push(`Missing ${t} in environment variables`)}),e.length>0)throw new Error(e.join(`
`))}},y=new j;var q=g(require("express")),oe=g(require("cors"));var B=(a,e,r,t)=>{let s=a.status||500;switch(s){case 400:return r.status(s).json({message:"Bad Request"});case 401:return r.status(s).json({message:"Unauthorized"});case 403:return r.status(s).json({message:"Forbidden"});case 404:return r.status(s).json({message:"Not Found"})}return console.error(a),r.status(s).json({message:"Something went wrong. Please try again later."})};var C=g(require("jsonwebtoken"));var M=class{constructor(){f(this,"create_token",async(e,r,t="")=>C.default.sign({email:e,owner:r,business:t},y.JWT_SECRET,{expiresIn:"48h"}))}},N=new M;var _=g(require("bcryptjs"));var F=class{constructor(){f(this,"password_crypt",async e=>{let r=await _.default.genSalt(10);return _.default.hash(e,r)});f(this,"password_compare",async(e,r)=>await _.default.compare(e,r))}},E=new F;var A=require("@prisma/client");var u;y.ENVIRONMENT==="production"?u=new A.PrismaClient:(globalThis.prisma||(globalThis.prisma=new A.PrismaClient),u=globalThis.prisma);var D=(a,e)=>{let r=new Date,t=a.registeredAt,s=(r.getTime()-t.getTime())/(1e3*60*60*24*365),n=e.reduce((R,x)=>R+x.income,0);s<.3?n*=.8:s<1.5?n*=.9:s>2&&(n*=1.1);let i=3,c=e.reduce((R,x)=>R+x.income,0),m=e.reduce((R,x)=>R+x.loss,0),p=c/(m||1);p>2&&i++,p>4&&i++,p<1&&i--,p<.5&&i--;let o=e.reduce((R,x)=>R+x.taxPaid,0),d=e.reduce((R,x)=>R+x.taxPayable,0),b=o/(d||1);b>.9&&i++,b<.7&&i--;let l=Math.max(1,Math.min(5,i));return{sumAssured:n,safetyRating:l}};var te=g(require("express"));var h=g(require("zod")),k=h.default.object({promoter_name:h.default.string(),business_name:h.default.string(),email:h.default.string().email(),password:h.default.string()}),U=h.default.object({email:h.default.string().email(),password:h.default.string()});var T=g(require("zod")),O=T.default.object({date:T.default.string(),id:T.default.string(),amount:T.default.number(),invoice:T.default.string()});var Y=async(a,e,r)=>{try{let t=a.body,s=k.safeParse(t);if(!s.success)return e.status(403).json({message:"enter required fields"});if(await u.user.findFirst({where:{email:s.data.email}}))return e.status(400).json({message:"email already exists"});if(await u.user.findFirst({where:{AND:[{business_name:s.data.business_name.toLowerCase()},{promoter_name:s.data.promoter_name.toLowerCase()}]}}))return e.status(400).json({message:"business already added"});let c=await E.password_crypt(s.data.password);await u.user.create({data:{email:s.data.email,password:c,business_name:s.data.business_name.toLowerCase(),promoter_name:s.data.promoter_name.toLowerCase()}});let m=await N.create_token(s.data.email,s.data.promoter_name,s.data.business_name);e.status(201).json({message:"business registered successfully",token:m})}catch(t){r(t)}};var W=async(a,e,r)=>{try{let t=a.body,s=U.safeParse(t);if(!s.success)return e.status(403).json({message:"enter required fields"});let n=await u.user.findFirst({where:{email:s.data.email}});if(!n)return e.status(400).json({message:"email is incorrect"});if(!await E.password_compare(s.data.password,n.password))return e.status(400).json({message:"password is incorrect"});let c=await N.create_token(s.data.email,n.promoter_name,n.business_name);e.status(201).json({message:"business Login successfully",token:c})}catch(t){r(t)}};var J=async(a,e,r)=>{try{let t=a.user.email,s=a.body;console.log(s);let n=O.safeParse(s);if(!n.success)return e.status(403).json({message:"enter required fields"});let i=await u.user.findFirst({where:{email:t},select:{id:!0,sumAssured:!0}}),c=await u.user.findFirst({where:{id:n.data.id},select:{id:!0,sumAssured:!0}});return!i||!c?e.status(200).json({message:"seller or buyer not found"}):n.data.amount>c?.sumAssured||n.data.amount>i?.sumAssured?e.status(200).json({message:"Insufficient Sum assured"}):(await u.transaction.create({data:{buyerId:i.id,sellerId:c.id,amount:n.data.amount,date:n.data.date,invoice:s.invoice,status:"PENDING"}}),e.status(200).json({message:"transaction initiated"}))}catch(t){r(t)}},V=async(a,e,r)=>{try{let t=a.user.email,s=await u.user.findFirst({where:{email:t},select:{id:!0}}),n=await u.transaction.findMany({where:{buyerId:s?.id},orderBy:{date:"desc"},take:10});if(!n||n.length===0)return e.status(200).json([]);let i=[...new Set(n.map(o=>o.sellerId))],m=(await u.user.findMany({where:{id:{in:i}},select:{id:!0,business_name:!0}})).reduce((o,d)=>(o[d.id]=d.business_name,o),{}),p=n.map(o=>{let d=m[o.sellerId],l=new Date(o.date).toLocaleString("default",{day:"2-digit",month:"long"});return{id:o.id,date:l,amount:o.amount,status:o.status,sellerName:d}});e.send(p)}catch(t){r(t)}},z=async(a,e,r)=>{try{let t=a.user.email,s=await u.user.findFirst({where:{email:t},select:{id:!0}}),n=await u.transaction.findMany({where:{sellerId:s?.id},take:10,orderBy:{date:"desc"}});if(!n||n.length===0)return e.status(200).json([]);let i=[...new Set(n.map(o=>o.buyerId))],m=(await u.user.findMany({where:{id:{in:i}},select:{id:!0,business_name:!0}})).reduce((o,d)=>(o[d.id]=d.business_name,o),{}),p=n.map(o=>{let d=m[o.buyerId],l=new Date(o.date).toLocaleString("default",{month:"long",day:"2-digit"});return{id:o.id,date:l,amount:o.amount,status:o.status,buyerName:d}});e.send(p)}catch(t){r(t)}},G=async(a,e,r)=>{try{let t=a.user.email,s=await u.user.findFirst({where:{email:t},select:{id:!0}}),n=await u.transaction.findMany({where:{sellerId:s?.id,status:"PENDING"},take:10,orderBy:{date:"desc"},select:{id:!0,amount:!0,date:!0,buyerId:!0,invoice:!0}});if(!n||n.length===0)return e.status(200).json([]);let i=[...new Set(n.map(o=>o.buyerId))],m=(await u.user.findMany({where:{id:{in:i}},select:{id:!0,business_name:!0}})).reduce((o,d)=>(o[d.id]=d.business_name,o),{}),p=n.map(o=>{let d=new Date(o.date),b=`${d.getDate().toString().padStart(2,"0")}-${(d.getMonth()+1).toString().padStart(2,"0")}`;return{id:o.id,amount:o.amount,business_name:m[o.buyerId],date:b,invoice:o.invoice||null}});e.status(200).json(p)}catch(t){r(t)}},$=async(a,e,r)=>{try{let{id:t,type:s}=a.body;console.log(s),console.log(t);let n=await u.transaction.update({where:{id:t},data:{status:s}});e.send({message:"Approved"})}catch(t){r(t)}},H=async(a,e,r)=>{let t=a.user.email,s=await u.user.findFirst({where:{email:t},select:{id:!0}});if(!s)return e.status(200).json({message:"user not found"});try{let i=(await u.transaction.findMany({where:{OR:[{buyerId:s.id,status:{in:["CLAIM_BUYER","CLAIM_SELLER"]}},{sellerId:s.id,status:{in:["CLAIM_BUYER","CLAIM_SELLER"]}}]},include:{buyer:{select:{id:!0,email:!0,business_name:!0}},seller:{select:{id:!0,email:!0,business_name:!0}}}})).map(c=>({...c,claimType:c.status==="CLAIM_BUYER"?"Buyer":"Seller",claimedBy:c.status==="CLAIM_BUYER"?c.buyer:c.seller,claimedAgainst:c.status==="CLAIM_BUYER"?c.seller:c.buyer}));e.json(i)}catch(n){r(n)}},Z=async(a,e,r)=>{let{userEmail:t}=a.params;try{let s=await u.transaction.findMany({where:{OR:[{buyer:{email:t}},{seller:{email:t}}],status:{in:["PENDING","ISSUE"]}},include:{buyer:{select:{email:!0,business_name:!0}},seller:{select:{email:!0,business_name:!0}}}});e.json(s)}catch(s){r(s)}},K=async(a,e,r)=>{let{transactionId:t,userEmail:s,claimType:n}=a.body;try{let i=await u.transaction.findUnique({where:{id:t},include:{buyer:{select:{email:!0}},seller:{select:{email:!0}}}});if(!i)return e.status(404).json({error:"Transaction not found"});let c;if(n==="seller"&&i.seller.email===s)c="CLAIM_SELLER";else if(n==="buyer"&&i.buyer.email===s)c="CLAIM_BUYER";else return e.status(400).json({error:"Invalid claim type or user"});let m=await u.transaction.update({where:{id:t},data:{status:c}});e.json(m)}catch(i){r(i)}};var Q=g(require("axios")),X=g(require("pdf-parse"));var ee=async(a,e,r)=>{try{let t=a.user.email,s=a.body.url,n=await Q.default.get(s,{responseType:"arraybuffer"}),c=(await(0,X.default)(n.data)).text,m=fe(c);if("message"in m)return e.json(m);let p=await u.user.findFirst({where:{email:t}});if(!p)return e.status(400).json({message:"user not found"});let o=await u.funds.create({data:{name:m.name,formNumber:m.formNumber,loss:m.loss,income:m.income,taxPayable:m.taxPayable,taxPaid:m.taxPaid,userId:p.id}}),d=await u.funds.findMany({where:{userId:p.id}}),b=D(p,d);await u.user.update({where:{id:p.id},data:{sumAssured:b.sumAssured,safetyRating:b.safetyRating}}),e.json(o)}catch(t){r(t)}};function fe(a){let e={name:"",formNumber:"",businessLoss:0,totalIncome:0,totalTaxInterestFeePayable:0,taxesPaid:0,accretedIncome:0,additionalTaxInterestPayable:0,taxInterestPaid:0},r={name:"",formNumber:"",loss:NaN,income:NaN,taxPaid:NaN,taxPayable:NaN},t=a.match(/Name([A-Z\s]+)/);t&&(e.name=t[1].trim().substring(0,t[1].trim().length-2));let s=a.match(/Form Number([A-Z0-9-]+)/);s&&(e.formNumber=s[1].trim());let n=a.match(/Total Income\s*([\d,]+)/);if(n){let l=n[1].trim().replace(/,/g,"");e.formNumber==="ITR-4"?e.totalIncome=parseFloat(l)||0:e.totalIncome=parseFloat(l.substring(1))||0}let i=a.match(/Current Year business loss, if any\s*([\d,]+)/);if(i){let l=i[1].trim().replace(/,/g,"");e.businessLoss=parseFloat(l.substring(1))||0}let c=a.match(/Total tax, interest and Fee payable\s*([\d,]+)/);if(c){let l=c[1].trim().replace(/,/g,"");e.totalTaxInterestFeePayable=parseFloat(l.substring(1))||0}let m=a.match(/Taxes Paid\s*([\d,]+)/);if(m){let l=m[1].trim().replace(/,/g,"");e.taxesPaid=parseFloat(l.substring(1))||0}let p=a.match(/Accreted Income as per section 115TD\s*([\d,]+)/);if(p){let l=p[1].trim().replace(/,/g,"");e.accretedIncome=parseFloat(l.substring(2))||0}let o=a.match(/Additional Tax and interest payable\s*([\d,]+)/);if(o){let l=o[1].trim().replace(/,/g,"");e.additionalTaxInterestPayable=parseFloat(l.substring(2))||0}let d=a.match(/Tax and interest paid\s*([\d,]+)/);if(d){let l=d[1].trim().replace(/,/g,"");e.taxInterestPaid=parseFloat(l.substring(2))||0}return r.name=e.name,r.formNumber=e.formNumber,r.loss=e.businessLoss,r.income=e.totalIncome+e.accretedIncome,r.taxPaid=e.taxesPaid+e.taxInterestPaid,r.taxPayable=e.totalTaxInterestFeePayable+e.additionalTaxInterestPayable,["ITR-3","ITR-4","ITR-5","ITR-7"].includes(r.formNumber)?r:{message:"document is not valid"}}var se=async(a,e,r)=>{try{let{query:t}=a.query;if(typeof t!="string")return e.status(400).json({error:"Invalid search query"});let s=await u.user.findMany({where:{OR:[{business_name:{contains:t,mode:"insensitive"}},{promoter_name:{contains:t,mode:"insensitive"}}]},select:{id:!0,business_name:!0,promoter_name:!0,sumAssured:!0,safetyRating:!0},take:10});e.status(200).json(s)}catch{e.status(500).json({error:"Error searching users"})}};var v=te.default.Router();v.post("/register",Y).post("/login",W);var re=g(require("express"));var us=require("dotenv/config"),ae=g(require("jsonwebtoken"));async function I(a,e,r){let t=a.headers.authorization;if(!t)return e.status(403).json({success:!1,data:"Not Authorised"});try{let n=t.split(" ")[1],c=ae.default.verify(n,y.JWT_SECRET);a.user=c}catch(s){return s instanceof Error?e.status(400).json({success:!1,data:s.message}):e.status(400).json({success:!1,data:"Something went wrong"})}r()}var L=re.default.Router();L.post("/new",I,J).get("/buyer",I,V).get("/seller",I,z).post("/search",se).get("/pending",I,G).post("/approve",$).post("/claim",I,H).get("/transactions/:userEmail",Z).post("/makeclaim",K);var ne=g(require("express"));var S=ne.default.Router();S.post("/add",I,ee);var w=(0,q.default)();w.use((0,oe.default)());w.use(q.default.json());w.get("/",(a,e)=>{e.json({message:"Welcome to the TrustTrade"})});w.use("/auth",v);w.use("/transact",L);w.use("/funds",S);w.use(B);y.verifyConfig();w.listen(y.PORT,()=>{console.log(`Server running on port ${y.PORT}`)});
//# sourceMappingURL=index.js.map
