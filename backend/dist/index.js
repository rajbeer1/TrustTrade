var Q=Object.create;var I=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var ee=Object.getOwnPropertyNames;var se=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty;var ae=(s,e,t)=>e in s?I(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var re=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of ee(e))!te.call(s,a)&&a!==t&&I(s,a,{get:()=>e[a],enumerable:!(r=X(e,a))||r.enumerable});return s};var f=(s,e,t)=>(t=s!=null?Q(se(s)):{},re(e||!s||!s.__esModule?I(t,"default",{value:s,enumerable:!0}):t,s));var d=(s,e,t)=>ae(s,typeof e!="symbol"?e+"":e,t);var ie=require("dotenv/config");var P=class{constructor(){d(this,"PORT");d(this,"DATABASE_URL");d(this,"JWT_SECRET");d(this,"email_sender");d(this,"email_sender_pass");d(this,"Front_url");d(this,"ENVIRONMENT");this.PORT=Number(process.env.PORT)||3500,this.DATABASE_URL=process.env.DATABASE_URL||"",this.JWT_SECRET=process.env.JWT_SECRET||"udduLovesToGetDominated",this.ENVIRONMENT=process.env.ENVIRONMENT||"development"}verifyConfig(){let e=[];if(["DATABASE_URL"].forEach(r=>{process.env[r]||e.push(`Missing ${r} in environment variables`)}),e.length>0)throw new Error(e.join(`
`))}},b=new P;var L=f(require("express")),K=f(require("cors"));var M=(s,e,t,r)=>{let a=s.status||500;switch(a){case 400:return t.status(a).json({message:"Bad Request"});case 401:return t.status(a).json({message:"Unauthorized"});case 403:return t.status(a).json({message:"Forbidden"});case 404:return t.status(a).json({message:"Not Found"})}return console.error(s),t.status(a).json({message:"Something went wrong. Please try again later."})};var q=f(require("jsonwebtoken"));var E=class{constructor(){d(this,"create_token",async(e,t,r="")=>q.default.sign({email:e,owner:t,business:r},b.JWT_SECRET,{expiresIn:"48h"}))}},R=new E;var T=f(require("bcryptjs"));var F=class{constructor(){d(this,"password_crypt",async e=>{let t=await T.default.genSalt(10);return T.default.hash(e,t)});d(this,"password_compare",async(e,t)=>await T.default.compare(e,t))}},N=new F;var _=require("@prisma/client");var i;b.ENVIRONMENT==="production"?i=new _.PrismaClient:(globalThis.prisma||(globalThis.prisma=new _.PrismaClient),i=globalThis.prisma);var Y=f(require("express"));var x=f(require("zod")),k=x.default.object({promoter_name:x.default.string(),business_name:x.default.string(),email:x.default.string().email(),password:x.default.string()}),B=x.default.object({email:x.default.string().email(),password:x.default.string()});var w=f(require("zod")),D=w.default.object({date:w.default.string(),sellerEmail:w.default.string(),amount:w.default.number()});var C=async(s,e,t)=>{try{let r=s.body,a=k.safeParse(r);if(!a.success)return e.status(403).json({message:"enter required fields"});if(await i.user.findFirst({where:{email:a.data.email}}))return e.status(400).json({message:"email already exists"});let m=await i.user.findFirst({where:{AND:[{business_name:a.data.business_name.toLowerCase()},{promoter_name:a.data.promoter_name.toLowerCase()}]}});if(console.log(m),m)return e.status(400).json({message:"business already added"});let l=await N.password_crypt(a.data.password);await i.user.create({data:{email:a.data.email,password:l,business_name:a.data.business_name.toLowerCase(),promoter_name:a.data.promoter_name.toLowerCase()}});let u=await R.create_token(a.data.email,a.data.promoter_name,a.data.business_name);e.status(201).json({message:"business registered successfully",token:u})}catch(r){t(r)}};var O=async(s,e,t)=>{try{let r=s.body,a=B.safeParse(r);if(!a.success)return e.status(403).json({message:"enter required fields"});let o=await i.user.findFirst({where:{email:a.data.email}});if(!o)return e.status(400).json({message:"email is incorrect"});if(!await N.password_compare(a.data.password,o.password))return e.status(400).json({message:"password is incorrect"});let l=await R.create_token(a.data.email,o.promoter_name,o.business_name);e.status(201).json({message:"business Login successfully",token:l})}catch(r){t(r)}};var U=async(s,e,t)=>{try{let r=s.user.email,a=s.body,o=D.safeParse(a);if(console.log(o.success),!o.success)return e.status(403).json({message:"enter required fields"});let m=await i.user.findFirst({where:{email:r},select:{id:!0}}),l=await i.user.findFirst({where:{email:o.data.sellerEmail},select:{id:!0}});return!m||!l?e.status(400).json({message:"seller or buyer not found"}):(await i.transaction.create({data:{buyerId:m.id,sellerId:l.id,amount:o.data.amount,date:o.data.date,status:"PENDING"}}),e.status(200).json({message:"transaction initiated"}))}catch(r){t(r)}},W=async(s,e,t)=>{try{let r=s.user.email,a=await i.user.findFirst({where:{email:r},select:{id:!0}}),o=await i.transaction.findMany({where:{buyerId:a?.id},orderBy:{date:"desc"},take:10});if(!o||o.length===0)return e.status(200).json([]);let m=[...new Set(o.map(n=>n.sellerId))],u=(await i.user.findMany({where:{id:{in:m}},select:{id:!0,business_name:!0}})).reduce((n,p)=>(n[p.id]=p.business_name,n),{}),g=o.map(n=>{let p=u[n.sellerId],c=new Date(n.date).toLocaleString("default",{day:"2-digit",month:"long"});return{id:n.id,date:c,amount:n.amount,status:n.status,sellerName:p}});console.log(g),e.send(g)}catch(r){t(r)}},J=async(s,e,t)=>{try{let r=s.user.email,a=await i.user.findFirst({where:{email:r},select:{id:!0}}),o=await i.transaction.findMany({where:{sellerId:a?.id},take:10,orderBy:{date:"desc"}});if(!o||o.length===0)return e.status(200).json([]);let m=[...new Set(o.map(n=>n.buyerId))],u=(await i.user.findMany({where:{id:{in:m}},select:{id:!0,business_name:!0}})).reduce((n,p)=>(n[p.id]=p.business_name,n),{}),g=o.map(n=>{let p=u[n.buyerId],c=new Date(n.date).toLocaleString("default",{month:"long",day:"2-digit"});return{id:n.id,date:c,amount:n.amount,status:n.status,buyerName:p}});console.log(g),e.send(g)}catch(r){t(r)}};var V=f(require("axios")),z=f(require("pdf-parse"));var H=async(s,e,t)=>{try{let r=s.user.email,a=s.body.url;console.log(a);let o=await V.default.get(a,{responseType:"arraybuffer"}),l=(await(0,z.default)(o.data)).text;console.log(l);let u=oe(l);if("message"in u)return e.json(u);let g=await i.user.findFirst({where:{email:r},select:{id:!0}});if(!g)return e.status(400).json({message:"user not found"});let n=await i.funds.create({data:{name:u.name,formNumber:u.formNumber,loss:u.loss,income:u.income,taxPayable:u.taxPayable,taxPaid:u.taxPaid,userId:g.id}});e.json(n)}catch(r){t(r)}};function oe(s){let e={name:"",formNumber:"",businessLoss:0,totalIncome:0,totalTaxInterestFeePayable:0,taxesPaid:0,accretedIncome:0,additionalTaxInterestPayable:0,taxInterestPaid:0},t={name:"",formNumber:"",loss:NaN,income:NaN,taxPaid:NaN,taxPayable:NaN},r=s.match(/Name([A-Z\s]+)/);r&&(e.name=r[1].trim().substring(0,r[1].trim().length-2));let a=s.match(/Form Number([A-Z0-9-]+)/);a&&(e.formNumber=a[1].trim());let o=s.match(/Total Income\s*([\d,]+)/);if(o){let c=o[1].trim().replace(/,/g,"");e.formNumber==="ITR-4"?e.totalIncome=parseFloat(c)||0:e.totalIncome=parseFloat(c.substring(1))||0}let m=s.match(/Current Year business loss, if any\s*([\d,]+)/);if(m){let c=m[1].trim().replace(/,/g,"");e.businessLoss=parseFloat(c.substring(1))||0}let l=s.match(/Total tax, interest and Fee payable\s*([\d,]+)/);if(l){let c=l[1].trim().replace(/,/g,"");e.totalTaxInterestFeePayable=parseFloat(c.substring(1))||0}let u=s.match(/Taxes Paid\s*([\d,]+)/);if(u){let c=u[1].trim().replace(/,/g,"");e.taxesPaid=parseFloat(c.substring(1))||0}let g=s.match(/Accreted Income as per section 115TD\s*([\d,]+)/);if(g){let c=g[1].trim().replace(/,/g,"");e.accretedIncome=parseFloat(c.substring(2))||0}let n=s.match(/Additional Tax and interest payable\s*([\d,]+)/);if(n){let c=n[1].trim().replace(/,/g,"");e.additionalTaxInterestPayable=parseFloat(c.substring(2))||0}let p=s.match(/Tax and interest paid\s*([\d,]+)/);if(p){let c=p[1].trim().replace(/,/g,"");e.taxInterestPaid=parseFloat(c.substring(2))||0}return t.name=e.name,t.formNumber=e.formNumber,t.loss=e.businessLoss,t.income=e.totalIncome+e.accretedIncome,t.taxPaid=e.taxesPaid+e.taxInterestPaid,t.taxPayable=e.totalTaxInterestFeePayable+e.additionalTaxInterestPayable,["ITR-3","ITR-4","ITR-5","ITR-7"].includes(t.formNumber)?t:{message:"document is not valid"}}var j=Y.default.Router();j.post("/register",C).post("/login",O);var Z=f(require("express"));var Ge=require("dotenv/config"),G=f(require("jsonwebtoken"));async function h(s,e,t){let r=s.headers.authorization;if(!r)return e.status(403).json({success:!1,data:"Not Authorised"});try{let o=r.split(" ")[1],l=G.default.verify(o,b.JWT_SECRET);s.user=l}catch(a){return a instanceof Error?e.status(400).json({success:!1,data:a.message}):e.status(400).json({success:!1,data:"Something went wrong"})}t()}var v=Z.default.Router();v.post("/new",h,U).get("/buyer",h,W).get("/seller",h,J);var $=f(require("express"));var S=$.default.Router();S.post("/add",h,H);var y=(0,L.default)();y.use((0,K.default)());y.use(L.default.json());y.get("/",(s,e)=>{e.json({message:"Welcome to the TrustTrade"})});y.use("/auth",j);y.use("/transact",v);y.use("/funds",S);y.use(M);b.verifyConfig();y.listen(b.PORT,()=>{console.log(`Server running on port ${b.PORT}`)});
//# sourceMappingURL=index.js.map
